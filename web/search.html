<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <title>Search</title>
    <!-- Firebase -->
    <script defer src="/__/firebase/8.1.1/firebase-app.js"></script>
    <script defer src="/__/firebase/8.1.1/firebase-auth.js"></script>
    <script defer src="/__/firebase/8.1.1/firebase-firestore.js"></script>
    <script defer src="/__/firebase/8.1.1/firebase-functions.js"></script>
    <script defer src="/__/firebase/8.1.1/firebase-analytics.js"></script>
    <script defer src="/__/firebase/8.1.1/firebase-performance.js"></script>
    <script defer src="/__/firebase/init.js?useEmulator=false"></script>
    <!-- Algolia -->
    <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.8.3/dist/instantsearch.production.min.js"
        integrity="sha256-LAGhRRdtVoD6RLo2qDQsU2mp+XVSciKRC8XPOBWmofM=" crossorigin="anonymous"></script>
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/cb61666d8f.js" crossorigin="anonymous"></script>
    <!-- CSS -->
    <link rel="stylesheet" href="./css/global.css">
    <link rel="stylesheet" href="./css/search.css">
    <link rel="stylesheet" href="./css/magicsuggest-min.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-yellow bg-transparant">
        <div class="container">
            <a class="navbar-brand font-weight-bold" href="/">
                <h1>dailycious</h1>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">

                </ul>
                <ul class="navbar-nav" id="formGroup">
                    <div class="input-group mb-3 mr-md-3">
                        <input type="text" id="searchbox" class="form-control">
                    </div>
                    <div>
                        <a class="btn btn-light" data-toggle="collapse" href="#bahanBahan" role="button"
                            aria-expanded="false" aria-controls="bahanBahan">Filter</a>
                    </div>
                </ul>
            </div>
        </div>
    </nav>


    <div class="container mt-5" style="margin-top: 8rem!important;">
        <div class="collapse multi-collapse pilihanBahan mb-3" id="bahanBahan">
            <div class="card card-body" id="ListBahan">


            </div>
        </div>
        <div class="d-flex justify-content-around flex-column" id="hits">
            <div class="text-center">
                <div class="spinner-border text-light" style="width: 3rem; height: 3rem; role=" status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
    <script src="./js/magicsuggest-min.js"></script>
    <script>
        $(document).scroll(function () {
            $('.navbar').toggleClass('bg-transparant', $(this).scrollTop() < $('.navbar').height());
        });
        document.addEventListener('DOMContentLoaded', function () {
            const db = firebase.firestore()
            firebase.auth().onAuthStateChanged(function (user) {
                let BahanFilter = []

                if (!user) {
                    document.getElementById('hits').classList.add('align-items-center')
                    document.getElementById('hits').classList.add('vh-50')
                    document.getElementById('hits').innerHTML = `
                    <div class="text-center">
                        <h3 class="text-white font-weight-bold">Harap Login untuk menggunakan fitur ini</h3>
                        <a href="./Login.html" class="btn btn-yellow">Login</a>
                    </div>
                    `
                    document.getElementById('formGroup').innerHTML = `
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="fas fa-cog" aria-hidden="true"></span> <span class="d-inline d-md-none ml-2">Pengaturan</span>
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink" id="dropdownWrapper">
                        <a class="dropdown-item" href="./Login.html"> Login</a>
                        <a class="dropdown-item" href="./Register.html">Regis</a>
                    </div>
                    </li>`
                } else {
                    db.collection('Users').doc(user.uid)
                        .onSnapshot(async (snap) => {
                            const userDB = snap.data()
                            const client = algoliasearch('VC8WCMFUPU', '71f394aa7d0003076acb0364cbed31c8');
                            const index = client.initIndex('resep');
                            const params = new URLSearchParams(window.location.search)
                            const judulResep = params.get('resep')
                            await db.collection('Data').doc('BuatSearch').get().then(doc => {
                                const data = doc.data()
                                let ListBahan = ''
                                var instance = $('#ListBahan').magicSuggest({
                                    data: data.listBahan,
                                    allowFreeEntries: false,
                                });

                                $(instance).on('selectionchange', function (e, m) {
                                    BahanFilter = instance.getValue().map(data => {
                                        return `bahan:${data}`
                                    })
                                    index.search('', {
                                        facetFilters: [
                                            BahanFilter
                                        ]
                                    }).then(res => {
                                        const { hits } = res
                                        let listCard = ""
                                        hits.forEach(item => {

                                            let varButton = ''
                                            if (userDB.listCookLater.includes(item.objectID)) {
                                                varButton = `
                                            <button type="button" class="btn btn-hapusCookLater" data-id=${item.objectID}>
                                                <span class="fas fa-bookmark" data-id=${item.objectID}></span>
                                            </button>
                                            `
                                            } else {
                                                varButton = `
                                            <button type="button" class="btn btn-TambahCookLater" data-id=${item.objectID}>
                                                <span class="far fa-bookmark" data-id=${item.objectID}></span>
                                            </button>
                                            `
                                            }
                                            const { thumbnail, judul, pembuatResep, bahan } = item
                                            listCard += `
                                                <div class="card mb-3 p-4">
                                                    <div class="row">
                                                        <div class="col-md-4 mb-md-0 mb-3">
                                                            <div class="imgThumb">
                                                                <img src="${thumbnail}" alt="${judul}">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-8 text-left">
                                                            <h3 class="font-weight-bold text-dark">${judul}</h3>
                                                            <h5>Oleh ${pembuatResep.nama}</h5>
                                                            <hr />
                                                            <br />
                                                            <p><b>Bahan</b> : ${bahan.length > 0 ? bahan.join(',') : bahan[0]}</p>
                                                            <div class="btnWrapper">    
                                                                <a href="./resep.html?resep=${judul.replace(' ', '-')}" class="btn" target="_blank" rel="noopener noreferrer"><span class="far fa-comment"></span></a>
                                                                <button type="button" class="btn btnShare"><span class="fas fa-share-alt"></span></button>
                                                                ${varButton}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                `
                                        })
                                        document.getElementById('hits').innerHTML = listCard
                                        addListener()
                                    })
                                })
                            })
                            if (judulResep) {
                                console.log(judulResep);
                                const hasil = await index.search(judulResep.replace('+', " "), {
                                    facetFilters: [
                                        BahanFilter
                                    ]
                                }).then((res) => {
                                    const { hits } = res
                                    let listCard = ''
                                    hits.forEach(item => {
                                        let varButton = ''
                                        if (userDB.listCookLater.includes(item.objectID)) {
                                            varButton = `
                                            <button type="button" class="btn btn-hapusCookLater" data-id=${item.objectID}>
                                                <span class="fas fa-bookmark" data-id=${item.objectID}></span>
                                            </button>
                                            `
                                        } else {
                                            varButton = `
                                            <button type="button" class="btn btn-TambahCookLater" data-id=${item.objectID}>
                                                <span class="far fa-bookmark" data-id=${item.objectID}></span>
                                            </button>
                                            `
                                        }
                                        const { thumbnail, judul, pembuatResep, bahan } = item
                                        listCard += `
                                                <div class="card mb-3 p-4">
                                                    <div class="row">
                                                        <div class="col-md-4 mb-md-0 mb-3">
                                                            <div class="imgThumb">
                                                                <img src="${thumbnail}" alt="${judul}">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-8 text-left">
                                                            <h3 class="font-weight-bold text-dark">${judul}</h3>
                                                            <h5>Oleh ${pembuatResep.nama}</h5>
                                                            <hr />
                                                            <br />
                                                            <p><b>Bahan</b> : ${bahan.length > 0 ? bahan.join(',') : bahan[0]}</p>
                                                            <div class="btnWrapper">    
                                                                <a href="./resep.html?resep=${judul.replace(' ', '-')}" class="btn" target="_blank" rel="noopener noreferrer"><span class="far fa-comment"></span></a>
                                                                <button type="button" class="btn btnShare"><span class="fas fa-share-alt"></span></button>
                                                                ${varButton}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                `
                                    });

                                    return listCard

                                });
                                document.getElementById('hits').innerHTML = hasil
                                addListener()
                            } else {
                                db.collection('resep').limit(5).get().then(snap => {
                                    let listCard = ''
                                    snap.docs.forEach(doc => {
                                        const item = doc.data()
                                        let varButton = ''
                                        if (userDB.listCookLater.includes(doc.id)) {
                                            varButton = `
                                                <button type="button" class="btn btn-hapusCookLater" data-id=${doc.id}>
                                                    <span class="fas fa-bookmark" data-id=${doc.id}></span>
                                                </button>
                                                `
                                        } else {
                                            varButton = `
                                                <button type="button" class="btn btn-TambahCookLater" data-id=${doc.id}>
                                                    <span class="far fa-bookmark" data-id=${doc.id}></span>
                                                </button>
                                                `
                                        }
                                        const { thumbnail, judul, pembuatResep, bahan } = item
                                        listCard += `
                                                    <div class="card mb-3 p-4">
                                                        <div class="row">
                                                            <div class="col-md-4 mb-md-0 mb-3">
                                                                <div class="imgThumb">
                                                                    <img src="${thumbnail}" alt="${judul}">
                                                                </div>
                                                            </div>
                                                            <div class="col-md-8 text-left">
                                                                <h3 class="font-weight-bold text-dark">${judul}</h3>
                                                                <h5>Oleh ${pembuatResep.nama}</h5>
                                                                <hr />
                                                                <br />
                                                                <p><b>Bahan</b> : ${bahan.length > 0 ? bahan.join(',') : bahan[0]}</p>
                                                                <div class="btnWrapper">    
                                                                    <a href="./resep.html?resep=${judul.replace(' ', '-')}" class="btn" target="_blank" rel="noopener noreferrer"><span class="far fa-comment"></span></a>
                                                                    <button type="button" class="btn btnShare"><span class="fas fa-share-alt"></span></button>
                                                                    ${varButton}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    `
                                    })
                                    document.getElementById('hits').innerHTML = listCard
                                    addListener()
                                })
                            }

                            document.getElementById('searchbox').addEventListener('change', async (e) => {
                                const hasil = await index.search(e.target.value, {
                                    facetFilters: [
                                        BahanFilter
                                    ]
                                }).then((res) => {
                                    const { hits } = res
                                    let listCard = ''
                                    hits.forEach(item => {
                                        let varButton = ''
                                        if (userDB.listCookLater.includes(item.objectID)) {
                                            varButton = `
                                            <button type="button" class="btn btn-hapusCookLater" data-id=${item.objectID}>
                                                <span class="fas fa-bookmark" data-id=${item.objectID}></span>
                                            </button>
                                            `
                                        } else {
                                            varButton = `
                                            <button type="button" class="btn btn-TambahCookLater" data-id=${item.objectID}>
                                                <span class="far fa-bookmark" data-id=${item.objectID}></span>
                                            </button>
                                            `
                                        }
                                        const { thumbnail, judul, pembuatResep, bahan } = item
                                        listCard += `
                                                <div class="card mb-3 p-4">
                                                    <div class="row">
                                                        <div class="col-md-4 mb-md-0 mb-3">
                                                            <div class="imgThumb">
                                                                <img src="${thumbnail}" alt="${judul}">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-8 text-left">
                                                            <h3 class="font-weight-bold text-dark">${judul}</h3>
                                                            <h5>Oleh ${pembuatResep.nama}</h5>
                                                            <hr />
                                                            <br />
                                                            <p><b>Bahan</b> : ${bahan.length > 0 ? bahan.join(',') : bahan[0]}</p>
                                                            <div class="btnWrapper">    
                                                                <a href="./resep.html?resep=${judul.replace(' ', '-')}" class="btn" target="_blank" rel="noopener noreferrer"><span class="far fa-comment"></span></a>
                                                                <button type="button" class="btn btnShare"><span class="fas fa-share-alt"></span></button>
                                                                ${varButton}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                `
                                    });

                                    return listCard

                                });
                                document.getElementById('hits').innerHTML = hasil
                                addListener()
                            })
                        })

                    function addListener() {
                        $('.btn-TambahCookLater').click((e) => {
                            const idResep = e.target.dataset.id
                            db.collection('Users')
                                .doc(user.uid).update({
                                    listCookLater: firebase.firestore.FieldValue.arrayUnion(idResep)
                                }).then(() => {
                                    console.log('Berhasil disimpan');
                                    db.collection('resep').doc(idResep).update({
                                        cookLaterCount: firebase.firestore.FieldValue.increment(1)
                                    }).then(() => { console.log('berhasil') }).catch(err => { console.log(err) })
                                }).catch(err => {
                                    console.log(err);
                                })
                        })
                        $('.btn-hapusCookLater').click((e) => {
                            const idResep = e.target.dataset.id
                            db.collection('Users')
                                .doc(user.uid).update({
                                    listCookLater: firebase.firestore.FieldValue.arrayRemove(idResep)
                                }).then(() => {
                                    console.log('Berhasil disimpan');
                                    db.collection('resep').doc(idResep).update({
                                        cookLaterCount: firebase.firestore.FieldValue.increment(-1)
                                    }).then(() => { console.log('berhasil') }).catch(err => { console.log(err) })
                                }).catch(err => {
                                    console.log(err);
                                })
                        })
                    }


                }
            });
        })

    </script>
</body>

</html>