<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>dailycious</title>
  <script defer src="/__/firebase/8.1.1/firebase-app.js"></script>
  <script defer src="/__/firebase/8.1.1/firebase-auth.js"></script>
  <script defer src="/__/firebase/8.1.1/firebase-firestore.js"></script>
  <script defer src="/__/firebase/8.1.1/firebase-functions.js"></script>
  <script defer src="/__/firebase/8.1.1/firebase-analytics.js"></script>
  <script defer src="/__/firebase/8.1.1/firebase-performance.js"></script>
  <script defer src="/__/firebase/init.js?useEmulator=false"></script>
  <!-- Font -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/cb61666d8f.js" crossorigin="anonymous"></script>
  <!-- CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <link rel="stylesheet" href="./css/global.css">
  <link rel="stylesheet" href="./css/resep.css">
  <link rel="stylesheet" href="./css/share.css">
</head>

<body>

  <nav class="navbar navbar-expand-lg navbar-light navbar-orange">
    <div class="container">
      <a class="navbar-brand font-weight-bold" href="/">dailycious</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">

        </ul>
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="./search.html">
              <span class="fas fa-search"></span>
            </a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button"
              data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span class="fas fa-cog"></span>
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink" id="dropdownWrapper">

            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container my-5" id="container">

    <div class="d-flex align-items-center justify-content-center flex-column">
      <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status"></div>
      <h3 class="font-weight-bold mt-3">Loading...</h3>
    </div>

  </div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Bagikan</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <!-- Sharingbutton Facebook -->
        <a id="btnFacebook" class="resp-sharing-button__link" href="https://facebook.com/sharer/sharer.php?u=" target="_blank" rel="noopener" aria-label="">
          <div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg>
            </div>
          </div>
        </a>

        <!-- Sharingbutton Twitter -->
        <a id="btnTwitter" class="resp-sharing-button__link" href="https://twitter.com/intent/tweet?text=" target="_blank" rel="noopener" aria-label="">
          <div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5 0-4.55 2.04-4.55 4.54 0 .36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3 0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35 0 12.92-6.92 12.92-12.93 0-.2 0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/></svg>
            </div>
          </div>
        </a>

        <!-- Sharingbutton WhatsApp -->
        <a id="btnWA" class="resp-sharing-button__link" href="whatsapp://send?text=" target="_blank" rel="noopener" aria-label="">
          <div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.1 3.9C17.9 1.7 15 .5 12 .5 5.8.5.7 5.6.7 11.9c0 2 .5 3.9 1.5 5.6L.6 23.4l6-1.6c1.6.9 3.5 1.3 5.4 1.3 6.3 0 11.4-5.1 11.4-11.4-.1-2.8-1.2-5.7-3.3-7.8zM12 21.4c-1.7 0-3.3-.5-4.8-1.3l-.4-.2-3.5 1 1-3.4L4 17c-1-1.5-1.4-3.2-1.4-5.1 0-5.2 4.2-9.4 9.4-9.4 2.5 0 4.9 1 6.7 2.8 1.8 1.8 2.8 4.2 2.8 6.7-.1 5.2-4.3 9.4-9.5 9.4zm5.1-7.1c-.3-.1-1.7-.9-1.9-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1s-1.2-.5-2.3-1.4c-.9-.8-1.4-1.7-1.6-2-.2-.3 0-.5.1-.6s.3-.3.4-.5c.2-.1.3-.3.4-.5.1-.2 0-.4 0-.5C10 9 9.3 7.6 9 7c-.1-.4-.4-.3-.5-.3h-.6s-.4.1-.7.3c-.3.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.1 4.9 4.3.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.3.2-.7.2-1.2.2-1.3-.1-.3-.3-.4-.6-.5z"/></svg>
            </div>
          </div>
        </a>
      </div>
    </div>
  </div>
</div>

  <!-- Modal -->
  <div class="modal fade" id="ModalLogin" tabindex="-1" aria-labelledby="ModalLoginLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body">
          Kamu harus masuk terlebih dahulu untuk menyimpan resep ini
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <a href="./Login.html" class="btn btn-orange">Masuk</a>
        </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
    crossorigin="anonymous"></script>
  <script src="https://cdn.tiny.cloud/1/emahnh5u9va59zls67qf1ue25ridax44s0sr7kiowxxsuis0/tinymce/5/tinymce.min.js"
    referrerpolicy="origin"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const params = new URLSearchParams(window.location.search)
      const slug = params.get('resep')
      const db = firebase.firestore();

      function addURLtoShare () {
        const url = window.location.href
        let text = "Cobalah resep ini sekarang juga! "
        text = text.replace(/\s/ig, '%20')
        console.log(text);
        document.getElementById('btnFacebook').href += url
        document.getElementById('btnTwitter').href += text + '&url=' + url
        document.getElementById('btnWA').href += text + url
      }
      addURLtoShare()
      firebase.auth().onAuthStateChanged(async function (user) {
        const dropdownWrapper = document.getElementById('dropdownWrapper')
        let isAdmin = false
        if (user) {
          const claims = (await user.getIdTokenResult()).claims
          isAdmin = claims.admin ? true : false
          dropdownWrapper.innerHTML = `
            <a class="dropdown-item" href = "./dashboard.html" >Dashboard</a >
            <a class="dropdown-item" href="./update.html">Update Profile</a>
            <button class="btn dropdown-item" id="logout">
                Signout
            </button>
          `
          document.getElementById('logout').addEventListener('click', (e) => {
            e.preventDefault();
            return firebase.auth().signOut().then(function () {
              window.location.href = './Login.html'
            }).catch(function (error) {
              console.log(error);
            });
          })
        } else {
          dropdownWrapper.innerHTML = `
            <a class="dropdown-item" href = "./Login.html" > Login</a >
            <a class="dropdown-item" href="./Register.html">Regis</a>
          `
        }

        const resepRef = db.collection("resep").where("judul", "==", slug.replace('-', ' '))
        const resQuery = await resepRef.limit(1).get()
        if (resQuery.empty) {
          document.getElementById('container').innerHTML = `
          <div class="d-flex justify-content-center align-items-center flex-column">
            <h1 class="font-weight-bold">404</h1>
            <p>Resep yang kamu cari tidak ada</p>
            <a href="./" class="btn btn-orange">Kembali ke Beranda</a>
          </div>`
          return
        } else {

          function RenderContainer() {
            document.getElementById('container').innerHTML = `
              <div id="header" class="text-center">
              </div>
              <div class="d-flex justify-content-center" id="listBtn">
              </div>
              <div class="card my-3">
                <div class="card-body" id="resepDoc">
                </div>
              </div>
              <h4 class="font-weight-bold">Tulis Komentar</h4>
              <form id="formUpdate">
                <div class="card my-3">
                  <div class="card-body">
                    <div class="form-group">
                      <textarea class="form-control" placeholder="Masukkan Komentar" id="newKomen" rows="7  "></textarea>
                    </div>
                  </div>
                </div>
                <div class="text-right">
                  <button class="btn btn-black font-weight-bold">Komentar</button>
                </div>
              </form>
              <h4 class="font-weight-bold">Tulis Komentar</h4>
              <div class="card mb-3">
                <div class="card-body" id="ListKomentar">

                </div>
              </div>
              `
          }

          function renderListBtn(btn) {
            document.getElementById('listBtn').innerHTML = btn
          }
          RenderContainer();
          if (user) {
            const UseDocRef = db.collection('Users').doc(user.uid)
            await UseDocRef.onSnapshot(doc => {
              let btn = `
                <div class="tombol">
                  <a href="#ListKomentar" class="btn">
                    <span class="icon">
                      <i class="far fa-comment"></i>
                    </span>
                    <span>Komentar</span>
                  </a>
                </div>
                <div class="tombol">
                  <button class="btn" data-toggle="modal" data-target="#exampleModal">
                    <span class="icon">
                      <i class="fas fa-share-alt"></i>
                    </span>
                    <span>Bagikan</span>
                  </button>
                </div>
              `
              if (doc.data().listCookLater.includes(res.id)) {
                btn += `
                <div class="tombol">
                  <button class="btn btnHapusCooklater" data-resepId="${resQuery.docs[0].id}" >
                    <span class="icon" data-resepId="${resQuery.docs[0].id}">
                      <i class="fas fa-bookmark" data-resepId="${resQuery.docs[0].id}"></i>
                    </span>
                    <span data-resepId="${resQuery.docs[0].id}" >Tersimpan</span>
                  </button>
                </div>
                  `
                renderListBtn(btn)
                $('.btnHapusCooklater').click(e => {
                  const resepId = e.target.dataset.resepid
                  UseDocRef.update({
                    listCookLater: firebase.firestore.FieldValue.arrayRemove(resepId)
                  })
                })

              } else {
                btn += `
                <div class="tombol">
                  <button class="btn btnSimpanCooklater" data-resepId="${resQuery.docs[0].id}" >
                    <span class="icon" data-resepId="${resQuery.docs[0].id}">
                      <i class="far fa-bookmark" data-resepId="${resQuery.docs[0].id}"></i>
                    </span>
                    <span data-resepId="${resQuery.docs[0].id}" >Simpan</span>
                  </button>
                </div>`
                renderListBtn(btn)
                $('.btnSimpanCooklater').click(e => {
                  const resepId = e.target.dataset.resepid
                  UseDocRef.update({
                    listCookLater: firebase.firestore.FieldValue.arrayUnion(resepId)
                  })
                })
              }

            });
          } else {
            const btn = `
                <div class="tombol">
                  <a href="#ListKomentar" class="btn">
                    <span class="icon">
                      <i class="far fa-comment"></i>
                    </span>
                    <span>Komentar</span>
                  </a>
                </div>
                <div class="tombol">
                  <button class="btn" data-toggle="modal" data-target="#exampleModal">
                    <span class="icon">
                      <i class="fas fa-share-alt"></i>
                    </span>
                    <span>Bagikan</span>
                  </button>
                </div>
                <div class="tombol">  
                  <button class="btn btnSimpan" data-toggle="modal" data-target="#ModalLogin" >
                    <span class="icon">
                      <i class="far fa-bookmark"></i>
                    </span>
                    <span >Simpan</span>
                  </button>
                </div>
                `
            renderListBtn(btn)
          }

         
          tinymce.init({
            selector: 'textarea',
            menubar: false,
            branding: false
          });
        }

        const res = resQuery.docs[0]
        const {
          judul,
          body,
          bahan,
          jmlBahan,
          pembuatResep,
          timestamp,
          deskripsi,
          thumbnail
        } = res.data()
        const KomenRef = db.collection("resep").doc(res.id).collection('komen')
        document.title = judul + " | Dailycious"
        let listBahan = '';
        bahan.forEach((data, i) => {
          listBahan += `<li>${data}  ${jmlBahan[i]}</li>`
        })
        const Resep = `
          <h3>Bahan-bahan</h3>
          <ul>
            ${listBahan}
          </ul>
          <h3>Langkah-langkah</h3>
          ${body}
        `
        let thumb = ''
        if (thumbnail !== '') {
          thumb = `<img src="${thumbnail}" alt="${judul}">`
        }
        const header = `
          <h1 class="text-center font-weight-bold" >${judul}</h1>
          <h3 class="text-center">Oleh ${pembuatResep.nama} | ${new Date(timestamp.seconds * 1000).toDateString()}</h3>
          <div class="thumbnail">
            ${thumb}
          </div>
        ${deskripsi}
        `
        document.getElementById('header').innerHTML = header
        document.getElementById('resepDoc').innerHTML = Resep

        KomenRef.onSnapshot(async (res) => {
          let finalData = ''
          const userCollections = await db.collection('Users').get()
          let users = []
          userCollections.forEach(doc => {
            users[doc.id] = doc.data()
          })
          res.docs.forEach(doc => {
            const {
              uid_sender,
              komen
            } = doc.data()
            finalData += `
            <div class="row komen-item mb-3">
              <div class="col-1 profile">
                  <img src="https://avatars.dicebear.com/api/human/${users[uid_sender].displayName.split(' ')[0]}.svg" alt="Profile" class="img-fluid">
              </div>
              <div class="col-10">
                  <h4 class="font-weight-bold text-dark">${users[uid_sender].displayName}</h4>
                  ${komen}
              </div>
              <div class="col-1">
                ${(user && user.uid === uid_sender) || isAdmin ? `<button type="button" class="btn py-0 px-2 btn-danger font-weight-bold btnHapusKomen" data-docid=${doc.id} >X</button>` : ''}
              </div>
          </div>
            `
          })
          if (!res.empty) {
            document.getElementById('ListKomentar').innerHTML = finalData

            $('.btnHapusKomen').click(async e => {
              const { docid } = e.target.dataset
              e.target.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div>`
              e.target.setAttribute('disabled', '')
              KomenRef.doc(docid).delete().catch(err => {
                console.log(err);
              })
            })

          } else {
            document.getElementById('ListKomentar').innerHTML = 'Belum ada komentar'
          }
        })


        document.getElementById('formUpdate').addEventListener('submit', async (e) => {
          e.preventDefault();
          const newKomen = document.getElementById('newKomen').value;
          return KomenRef.add({
            komen: newKomen,
            uid_sender: user.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          })
            .then(() => {
              document.getElementById('newKomen').value = ''
            })
            .catch(err => {
              console.log(err);
            })
        });

      })

    })
  </script>
</body>

</html>